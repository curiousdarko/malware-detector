# PUT YOUR API KEY IN VT_API_KEY.

import os
import sys
import logging
import pefile
import requests

# Define the DLL compatibility dictionary
DLL_COMPATIBILITY = {
    'kernel32.dll': ['VirtualAlloc', 'VirtualFree', 'VirtualProtect', 'VirtualQuery', 'CreateFile', 'ReadFile', 'WriteFile', 'CloseHandle'],
    'advapi32.dll': ['RegOpenKeyExA', 'RegQueryValueExA', 'RegSetValueExA', 'RegCloseKey'],
    'user32.dll': ['MessageBoxA'],
    'gdi32.dll': ['CreateCompatibleDC', 'CreateCompatibleBitmap', 'CreateFontIndirectA', 'SelectObject', 'BitBlt', 'DeleteDC', 'DeleteObject'],
    'ole32.dll': ['CoInitializeEx', 'CoCreateInstance', 'CoUninitialize'],
    'shell32.dll': ['ShellExecuteA'],
    'wininet.dll': ['InternetOpenA', 'InternetOpenUrlA', 'InternetReadFile', 'InternetCloseHandle'],
    'ws2_32.dll': ['WSAStartup', 'socket', 'connect', 'send', 'recv', 'closesocket', 'WSACleanup']
}

# Define the VirusTotal API key
VT_API_KEY = 'YOUR_API_KEY_HERE'

def log_activity(message):
    logging.basicConfig(filename='activity.log', level=logging.INFO)
    logging.info(message)

def detect_malicious(file_path):
    # Check if file exists
    if not os.path.exists(file_path):
        return False

    # Check if the file is a Windows executable
    try:
        pe = pefile.PE(file_path)
    except pefile.PEFormatError:
        return False

    # Check if the file is compatible with known DLLs
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        dll_name = entry.dll.decode().lower()
        if dll_name in DLL_COMPATIBILITY:
            for function in entry.imports:
                func_name = function.name.decode().lower()
                if func_name in DLL_COMPATIBILITY[dll_name]:
                    log_activity(f"Program {os.path.basename(file_path)} is compatible with {dll_name}.{func_name}")
        else:
            log_activity(f"Program {os.path.basename(file_path)} is not compatible with {dll_name}")

    # Check if the file tries to modify memory
    for section in pe.sections:
        if section.IMAGE_SCN_MEM_WRITE:
            log_activity(f"Program {os.path.basename(file_path)} tried to modify memory")

    # Check if the file tries to tamper with files
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        if 'kernel32.dll' in str(entry.dll):
            for function in entry.imports:
                if 'WriteFile' in str(function.name):
                    log_activity(f"Program {os.path.basename(file_path)} tried to tamper with files")

    # Check if the file communicates with an external server
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        if 'ws2_32.dll' in str(entry.dll):
            for function in entry.imports:
                if 'connect' in str(function.name):
                    log_activity(f"Program {os.path.basename(file_path)} sent a request to {function.name}")

    # Check if the file tries to modify the registry
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        if 'advapi32.dll' in str(entry.dll):
            for function in entry.imports:
                if 'RegOpenKeyExA' in str(function.name):
                    log_activity(f"Program {os.path.basename(file_path)} tried to modify the registry {function.name}")

    # Use VirusTotal API to scan the file
    url = 'https://www.virustotal.com/vtapi/v2/file/scan'
    params = {'apikey': VT_API_KEY}
    files = {'file': (os.path.basename(file_path), open(file_path, 'rb'))}
    response = requests.post(url, params=params, files=files)
    if response.status_code == 200:
        resource = response.json()['resource']
        # Check the scan results after some time
        url = f'https://www.virustotal.com/vtapi/v2/file/report?apikey={VT_API_KEY}&resource={resource}'
        response = requests.get(url)
        if response.status_code == 200:
            with open('scan.txt', 'w') as f:
                json_data = response.json()
                if json_data['response_code'] == 0:
                    f.write(f"No results found for file {os.path.basename(file_path)}")
                else:
                    positives = json_data['positives']
                    total = json_data['total']
                    f.write(f"File {os.path.basename(file_path)} has {positives}/{total} positive detections on VirusTotal\n")
                    for scanner, result in json_data['scans'].items():
                        if result['detected']:
                            f.write(f"{scanner}: {result['result']}\n")
    else:
        log_activity(f"Failed to scan file {os.path.basename(file_path)} with VirusTotal API")

    return True

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python detect_malicious.py <file_path>")
        sys.exit(1)

    file_path = sys.argv[1]
    detect_malicious(file_path)
